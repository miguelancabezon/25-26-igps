@startuml
title Ciclo de Vida del Préstamo

[*] --> Solicitado

state Solicitado #Yellow {
  entry / registrarSolicitud()
  entry / verificarDisponibilidad()
}
Solicitado --> Activo : aprobar [libro disponible]
Solicitado --> Cancelado : rechazar [libro no disponible]
Solicitado --> Cancelado : cancelar por usuario

state "En Curso" as EnCurso {
  state Activo #LightGreen {
    entry / enviarEmailConfirmacion()
    entry / actualizarDisponibilidadLibro()
    exit / registrarHistorial()
  }

  state Renovado #LightGreen {
    entry / extenderFechaVencimiento()
    entry / incrementarContadorRenovaciones()
  }

  state Vencido #LightCoral {
    entry / calcularMulta()
    entry / enviarNotificacionRetraso()
  }

  Activo --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
  Activo --> Activo : renovar [renovaciones >= 2]
  Activo --> Vencido : vencer plazo
  Renovado --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
  Renovado --> Vencido : vencer plazo
  Vencido --> Vencido : continuar vencido [>30 días]
  Vencido --> Devuelto : devolver con multa
}

EnCurso --> Devuelto : devolver [a tiempo]

state Devuelto #LightBlue {
  entry / liberarLibro()
  entry / procesarSiguienteReserva()
}

Devuelto --> [*]
Cancelado --> [*]

@enduml
