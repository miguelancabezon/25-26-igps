@startuml

title Ciclo de Vida del Préstamo de un libro

skinparam state {
  BackgroundColor #E8F5E9
  BorderColor #1B5E20
}

[*] --> Solicitado

state Solicitado #FFFFCC {
  Solicitado : entry / registrarSolicitud()
  Solicitado : entry / verificarDisponibilidad()
}

Solicitado --> Activo : aprobar\n[libro disponible]
Solicitado --> Cancelado : rechazar\n[libro no disponible]
Solicitado --> Cancelado : cancelar por usuario

state "En Curso" as EnCurso {
  
  [H] --> Activo

  state Activo #CCFFCC {
    Activo : entry / enviarEmailConfirmacion()
    Activo : entry / actualizarDisponibilidadLibro()
    Activo : exit / registrarHistorial()
  }

  state Renovado #CCFFCC {
    Renovado : entry / extenderFechaVencimiento()
    Renovado : entry / incrementarContadorRenovaciones()
  }

  state Vencido #FFCCCC {
    Vencido : entry / calcularMulta()
    Vencido : entry / enviarNotificacionRetraso()
  }

  Activo --> Renovado : renovar\n[renovaciones < 2 AND sin reservas]
  Activo --> Vencido : vencer plazo
  Activo --> Activo : renovar\n[renovaciones >= 2]\n<<rechazo>>

  Renovado --> Renovado : renovar\n[renovaciones < 2 AND sin reservas]
  Renovado --> Vencido : vencer plazo
}

EnCurso --> Devuelto : devolver\n[a tiempo]
EnCurso --> Vencido : vencer plazo

Vencido --> Devuelto : devolver con multa
Vencido --> Vencido : continuar vencido\n[>30 días]\n<<crítico>>

Devuelto : entry / liberarLibro()
Devuelto : entry / procesarSiguienteReserva()

Cancelado --> [*]
Devuelto --> [*]

@enduml
