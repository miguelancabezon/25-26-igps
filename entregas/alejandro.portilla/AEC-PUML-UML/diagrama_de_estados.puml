@startuml
title Diagrama de Estados - Ciclo de Vida del Préstamo


[*] --> Solicitado


state Solicitado #Yellow {
Solicited : entry / registrarSolicitud()
Solicited : entry / verificarDisponibilidad()
}


Solicitado --> Activo : aprobar [libro disponible]
Solicitado --> Cancelado : rechazar [libro no disponible]
Solicitado --> Cancelado : cancelar por usuario


state "En Curso" as EnCurso {
[H] as Hist
Hist --> Activo


state Activo {
entry / enviarEmailConfirmacion()
entry / actualizarDisponibilidadLibro()
exit / registrarHistorial()
}


state Renovado {
entry / extenderFechaVencimiento()
entry / incrementarContadorRenovaciones()
}


state Vencido {
entry / calcularMulta()
entry / enviarNotificacionRetraso()
}


Activo --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
Activo --> Activo : renovar [renovaciones >= 2] / note right: "rechazo renovación: límite alcanzado"
Activo --> Vencido : vencer plazo / note right: "after plazo"


Renovado --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
Renovado --> Vencido : vencer plazo


Vencido --> VencidoCritico : continuar vencido [>30 días]
Vencido --> Devuelto : devolver con multa
}


EnCurso --> Devuelto : devolver [a tiempo]


Devuelto : entry / liberarLibro()
Devuelto : entry / procesarSiguienteReserva()
Devuelto --> [*]


Cancelado : entry / notificarCancelacion()
Cancelado --> [*]


' Estado final explícito mostrado


' Estados especiales y transiciones adicionales
Activo --> Vencido : after 14 days
Renovado --> Vencido : after 14 days


' Transiciones etiquetadas (5 mínimo)
' [libro disponible], [renovaciones < 2], [sin reservas pendientes], [usuario sin multas], [a tiempo]


' Eventos/Acciones listadas en notas
note left
    Eventos claves: aprobar, rechazar, cancelar, devolver,
    renovar, vencer plazo, pagar multa, 14 días después (temporal)
end note


' Uso de fork/join: procesar notificaciones y registro en paralelo
fork
:enviarNotificacion();
fork again
:actualizarEstadisticas();
join


@enduml