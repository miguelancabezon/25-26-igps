@startuml
title préstamoDeBiblioteca

[*] --> Solicitado

'-------------------
' Estado Solicitado
'-------------------
state Solicitado {
  note right
    Estado inicial del préstamo.
    Decide aprobar, rechazar o cancelar.
  end note
}

'-------------------
' Superestado En Curso
'-------------------
state "En Curso" as EnCurso {
  
  [H]  ' historial para recordar último subestado

  ' Subestado Activo
  state Activo {
    entry / enviarEmailConfirmacion()
    entry / actualizarDisponibilidadLibro()
    exit / registrarHistorial()
  }

  ' Subestado Renovado
  state Renovado {
    entry / enviarEmailConfirmacion()
    entry / actualizarDisponibilidadLibro()
  }

  ' Subestado Vencido
  state Vencido {
    entry / calcularMulta()
    entry / enviarNotificacionRetraso()
  }

  ' Transiciones internas
  Activo --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
  Activo --> Activo : renovar [renovaciones >= 2 OR reservas pendientes] / mostrarMensajeRechazo()
  Activo --> Vencido : vencer plazo
  Activo --> Devuelto : devolver [a tiempo]

  Renovado --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
  Renovado --> Vencido : vencer plazo
  Renovado --> Devuelto : devolver [a tiempo]

  Vencido --> Devuelto : devolver / pagar multa
  Vencido --> Vencido : continuar vencido [>30 días] / alertaVencidoCritico
}

'-------------------
' Transiciones desde Solicitado
'-------------------
Solicitado --> Activo : aprobar [libro disponible]
Solicitado --> Cancelado : rechazar [libro no disponible]
Solicitado --> Cancelado : cancelar [usuario sin multas]

'-------------------
' Estados finales
'-------------------
Devuelto --> [*]
Cancelado --> [*]

'-------------------
' Estado de decisión
'-------------------
state "Decision Renovación" as Decision <<choice>>
Activo --> Decision : renovar
Renovado --> Decision : renovar
Decision --> Activo : renovación rechazada
Decision --> Renovado : renovación aprobada

'-------------------
' Fork y Join ejemplo
'-------------------
state fork_example <<fork>>
state join_example <<join>>

Solicitado --> fork_example : aprobar
fork_example --> Activo : enviarEmailConfirmacion()
fork_example --> Activo : actualizarDisponibilidadLibro()
Activo --> join_example
join_example --> EnCurso

@enduml
