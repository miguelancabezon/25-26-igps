@startuml
Activo --> Activo : renovar [renovaciones >= 2] / note right: "rechazo de renovación"
Activo --> Vencido : vencer plazo / note left: "after duración (14/30 días según rol)"


Renovado --> Renovado : renovar [renovaciones < 2 AND sin reservas pendientes]
Renovado --> Vencido : vencer plazo
Renovado --> Devuelto : devolver [a tiempo]


Vencido --> Devuelto : devolver con multa
Vencido --> VencidoCritico : continuar vencido [>30 días]


}


EnCurso --> Devuelto : devolver [a tiempo]


state VencidoCritico {
note right
Vencido crítico: acciones administrativas
(p.ej. bloqueo, notificación avanzada)
end note
}


Devuelto : entry / liberarLibro()
Devuelto : entry / procesarSiguienteReserva()
Devuelto --> [*]


Cancelado : entry / registrarCancelacion()
Cancelado --> [*]


' Eventos/acciones adicionales y forks


fork
note left
Evento temporal: after 14 days -> vencer plazo
Evento temporal: after 30 days -> continuar vencido
end note
fork again
note right
Evento: pagar multa -> puede habilitar renovaciones
end note
end fork


' Decisión para renovar (estado de decisión)
state "[choice] RenovacionCheck" as Decision
Decision --> Renovado : [renovaciones < 2 AND sin reservas pendientes]
Decision --> Activo : [renovaciones >= 2] / note right: "rechaza renovación"


' Historia para recordar último sub-estado de EnCurso
state "[H]" as History


' Etiquetas usadas en transiciones: [libro disponible], [renovaciones < 2], [sin reservas pendientes], [usuario sin multas], [a tiempo]


@enduml